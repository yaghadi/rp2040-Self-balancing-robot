#include <stdio.h>
#include <string.h>
#include <math.h>
#include "pico/stdlib.h"
#include "hardware/gpio.h"
#include "hardware/spi.h"
#include "max7219.h"
const uint8_t CMD_NOOP = 0;
const uint8_t CMD_DIGIT0 = 1; // Goes up to 8, for each line
const uint8_t CMD_DECODEMODE = 9;
const uint8_t CMD_BRIGHTNESS = 10;
const uint8_t CMD_SCANLIMIT = 11;
const uint8_t CMD_SHUTDOWN = 12;
const uint8_t CMD_DISPLAYTEST = 15;
// Font 8x8 Bitmap (ASCII)
const uint8_t FONT_8x8[95][8] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, //  
    {0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00}, // !
    {0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // "
    {0x36, 0x36, 0x7F, 0x36, 0x7F, 0x36, 0x36, 0x00}, // #
    {0x0C, 0x3F, 0x30, 0x3F, 0x0C, 0x3F, 0x30, 0x00}, // $
    {0x00, 0x36, 0x1C, 0x7F, 0x66, 0x66, 0x00, 0x00}, // %
    {0x00, 0x76, 0x6E, 0x1B, 0x7B, 0x05, 0x03, 0x00}, // &
    {0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // '
    {0x00, 0x0C, 0x18, 0x30, 0x30, 0x18, 0x0C, 0x00}, // (
    {0x00, 0x30, 0x18, 0x0C, 0x0C, 0x18, 0x30, 0x00}, // )
    {0x00, 0x36, 0x36, 0x7F, 0x36, 0x36, 0x36, 0x00}, // *
    {0x00, 0x08, 0x08, 0x3E, 0x08, 0x08, 0x00, 0x00}, // +
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30}, // ,
    {0x00, 0x00, 0x00, 0x3E, 0x00, 0x00, 0x00, 0x00}, // -
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00}, // .
    {0x00, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x00}, // /
    {0x00, 0x3E, 0x63, 0x67, 0x6B, 0x73, 0x3E, 0x00}, // 0
    {0x00, 0x0C, 0x1C, 0x3C, 0x0C, 0x0C, 0x3F, 0x00}, // 1
    {0x00, 0x3E, 0x63, 0x03, 0x0E, 0x38, 0x7F, 0x00}, // 2
    {0x00, 0x3F, 0x63, 0x0E, 0x1E, 0x63, 0x3F, 0x00}, // 3
    {0x00, 0x0C, 0x1C, 0x3C, 0x7C, 0x0C, 0x0C, 0x00}, // 4
    {0x00, 0x7F, 0x70, 0x7E, 0x03, 0x63, 0x3F, 0x00}, // 5
    {0x00, 0x3E, 0x38, 0x7F, 0x67, 0x63, 0x3E, 0x00}, // 6
    {0x00, 0x7F, 0x03, 0x06, 0x0C, 0x18, 0x18, 0x00}, // 7
    {0x00, 0x3F, 0x63, 0x3F, 0x63, 0x63, 0x3F, 0x00}, // 8
    {0x00, 0x3F, 0x63, 0x3F, 0x03, 0x06, 0x3C, 0x00}, // 9
    {0x00, 0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00}, // :
    {0x00, 0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x30}, // ;
    {0x00, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x18, 0x00}, // <
    {0x00, 0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00}, // =
    {0x00, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x18, 0x00}, // >
    {0x00, 0x3E, 0x63, 0x06, 0x1C, 0x08, 0x00, 0x00}, // ?
    {0x00, 0x3E, 0x63, 0x77, 0x7B, 0x6B, 0x63, 0x00}, // @
    {0x00, 0x3F, 0x63, 0x63, 0x3F, 0x63, 0x63, 0x00}, // A
    {0x00, 0x7F, 0x63, 0x7F, 0x63, 0x63, 0x7F, 0x00}, // B
    {0x00, 0x3E, 0x63, 0x60, 0x60, 0x63, 0x3E, 0x00}, // C
    {0x00, 0x7F, 0x63, 0x63, 0x63, 0x63, 0x7F, 0x00}, // D
    {0x00, 0x7F, 0x60, 0x7E, 0x60, 0x60, 0x7F, 0x00}, // E
    {0x00, 0x7F, 0x60, 0x7E, 0x60, 0x60, 0x60, 0x00}, // F
    {0x00, 0x3E, 0x63, 0x60, 0x67, 0x63, 0x3F, 0x00}, // G
    {0x00, 0x63, 0x63, 0x7F, 0x63, 0x63, 0x63, 0x00}, // H
    {0x00, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00}, // I
    {0x00, 0x3E, 0x0C, 0x0C, 0x0C, 0x6C, 0x3C, 0x00}, // J
    {0x00, 0x63, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0x00}, // K
    {0x00, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7F, 0x00}, // L
    {0x00, 0x63, 0x77, 0x7F, 0x6B, 0x63, 0x63, 0x00}, // M
    {0x00, 0x63, 0x73, 0x7B, 0x6F, 0x67, 0x63, 0x00}, // N
    {0x00, 0x3E, 0x63, 0x63, 0x63, 0x63, 0x3E, 0x00}, // O
    {0x00, 0x7F, 0x63, 0x63, 0x7F, 0x60, 0x60, 0x00}, // P
    {0x00, 0x3E, 0x63, 0x63, 0x67, 0x3F, 0x1F, 0x00}, // Q
    {0x00, 0x7F, 0x63, 0x63, 0x7F, 0x6C, 0x66, 0x00}, // R
    {0x00, 0x3F, 0x70, 0x3E, 0x1F, 0x63, 0x3F, 0x00}, // S
    {0x00, 0x7F, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00}, // T
    {0x00, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3E, 0x00}, // U
    {0x00, 0x63, 0x63, 0x63, 0x36, 0x36, 0x1C, 0x00}, // V
    {0x00, 0x63, 0x63, 0x6B, 0x6B, 0x7F, 0x36, 0x00}, // W
    {0x00, 0x63, 0x36, 0x1C, 0x1C, 0x36, 0x63, 0x00}, // X
    {0x00, 0x63, 0x63, 0x36, 0x1C, 0x18, 0x18, 0x00}, // Y
    {0x00, 0x7F, 0x07, 0x0E, 0x38, 0x70, 0x7F, 0x00}, // Z
    {0x00, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00}, // [
    {0x00, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x00}, // \'
    {0x00, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00}, // ]
    {0x00, 0x18, 0x3C, 0x66, 0x00, 0x00, 0x00, 0x00}, // ^
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF}, // _
    {0x00, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00}, // `
    {0x00, 0x00, 0x3E, 0x63, 0x3F, 0x63, 0x3F, 0x00}, // a
    {0x00, 0x60, 0x60, 0x7E, 0x63, 0x63, 0x7E, 0x00}, // b
    {0x00, 0x00, 0x3E, 0x63, 0x60, 0x63, 0x3E, 0x00}, // c
    {0x00, 0x1C, 0x1C, 0x3F, 0x63, 0x63, 0x3F, 0x00}, // d
    {0x00, 0x00, 0x3E, 0x63, 0x7F, 0x60, 0x3E, 0x00}, // e
    {0x00, 0x1E, 0x30, 0x7E, 0x30, 0x30, 0x30, 0x00}, // f
    {0x00, 0x00, 0x3F, 0x63, 0x63, 0x3F, 0x1C, 0x38}, // g
    {0x00, 0x60, 0x60, 0x7E, 0x63, 0x63, 0x63, 0x00}, // h
    {0x00, 0x18, 0x00, 0x3C, 0x18, 0x18, 0x3C, 0x00}, // i
    {0x00, 0x0C, 0x00, 0x0E, 0x0C, 0x0C, 0x6C, 0x38}, // j
    {0x00, 0x60, 0x60, 0x6F, 0x6C, 0x66, 0x63, 0x00}, // k
    {0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00}, // l
    {0x00, 0x00, 0x7E, 0x7F, 0x6B, 0x63, 0x63, 0x00}, // m
    {0x00, 0x00, 0x7E, 0x63, 0x63, 0x63, 0x63, 0x00}, // n
    {0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x3E, 0x00}, // o
    {0x00, 0x00, 0x7E, 0x63, 0x63, 0x7E, 0x60, 0x60}, // p
    {0x00, 0x00, 0x3F, 0x63, 0x63, 0x3F, 0x1C, 0x1C}, // q
    {0x00, 0x00, 0x6E, 0x6F, 0x60, 0x60, 0x60, 0x00}, // r
    {0x00, 0x00, 0x3F, 0x70, 0x3E, 0x1F, 0x03, 0x3E}, // s
    {0x00, 0x30, 0x30, 0x7F, 0x30, 0x30, 0x1C, 0x00}, // t
    {0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x3F, 0x00}, // u
    {0x00, 0x00, 0x63, 0x63, 0x36, 0x36, 0x1C, 0x00}, // v
    {0x00, 0x00, 0x63, 0x63, 0x6B, 0x6B, 0x3E, 0x00}, // w
    {0x00, 0x00, 0x63, 0x36, 0x1C, 0x36, 0x63, 0x00}, // x
    {0x00, 0x00, 0x3F, 0x63, 0x63, 0x3F, 0x1C, 0x38}, // y
    {0x00, 0x00, 0x7F, 0x07, 0x0E, 0x38, 0x7F, 0x00}, // z
    {0x00, 0x0E, 0x18, 0x18, 0x70, 0x18, 0x18, 0x0E}, // {
    {0x00, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18}, // |
    {0x00, 0x70, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x70}, // }
    {0x00, 0x63, 0x36, 0x1C, 0x00, 0x00, 0x00, 0x00}, // ~
};
//// Emotion animation frames
static const uint8_t ROBOT_EYES_FRAMES[][8] = {
    {0x00, 0x7E, 0x81, 0xB1, 0xB1, 0x81, 0x7E, 0x00},  // 0 - 'Rest Position'
    {0x00, 0x7C, 0x82, 0xB2, 0xB2, 0x82, 0x7C, 0x00},  // 1 - 'Blink 1'
    {0x00, 0x78, 0x84, 0xB4, 0xB4, 0x84, 0x78, 0x00},  // 2 - 'Blink 2'
    {0x00, 0x30, 0x48, 0x78, 0x78, 0x48, 0x30, 0x00},  // 3 - 'Blink 3'
    {0x00, 0x20, 0x50, 0x70, 0x70, 0x50, 0x20, 0x00},  // 4 - 'Blink 4'
    {0x00, 0x20, 0x60, 0x60, 0x60, 0x60, 0x20, 0x00},  // 5 - 'Blink 5'
    {0x00, 0x7E, 0x81, 0x81, 0xB1, 0xB1, 0x7E, 0x00},  // 6 - 'Right 1'
    {0x00, 0x00, 0x7E, 0x81, 0x81, 0xB1, 0xB1, 0x7E},  // 7 - 'Right 2'
    {0x00, 0x7E, 0xB1, 0xB1, 0x81, 0x81, 0x7E, 0x00},  // 8 - 'Left 1'
    {0x7E, 0xB1, 0xB1, 0x81, 0x81, 0x7E, 0x00, 0x00},  // 9 - 'Left 2'
    {0x00},                                            // 10
    {0x00, 0x7E, 0x81, 0x99, 0x99, 0x81, 0x7E, 0x00},  // 11 - 'Up 1'
    {0x00, 0x7E, 0x81, 0x8D, 0x8D, 0x81, 0x7E, 0x00},  // 12 - 'Up 2'
    {0x00, 0x7E, 0x81, 0x87, 0x87, 0x81, 0x7E, 0x00},  // 13 - 'Up 3'
    {0x00, 0x7E, 0x81, 0xE1, 0xE1, 0x81, 0x7E, 0x00},  // 14 - 'Down 1'
    {0x00, 0x7E, 0x81, 0xC1, 0xC1, 0x81, 0x7E, 0x00},  // 15 - 'Down 2'
    {0x00, 0x7C, 0x82, 0xC2, 0xC2, 0x82, 0x7C, 0x00},  // 16 - 'Down 3'
    {0x00, 0x7C, 0x82, 0xB1, 0xB1, 0x81, 0x7E, 0x00},  // 17 - 'Angry L 1'
    {0x00, 0x78, 0x84, 0xB2, 0xB1, 0x81, 0x7E, 0x00},  // 18 - 'Angry L 2'
    {0x00, 0x70, 0x88, 0xA4, 0xB2, 0x81, 0x7E, 0x00},  // 19 - 'Angry L 3'
    {0x00, 0x60, 0x90, 0xA8, 0xB4, 0x82, 0x7F, 0x00},  // 20 - 'Angry L 4'
    {0x00},                                            // 21
    {0x00, 0x7E, 0x81, 0xB1, 0xB1, 0x82, 0x7C, 0x00},  // 22 - 'Angry R 1'
    {0x00, 0x7E, 0x81, 0xB1, 0xB2, 0x84, 0x78, 0x00},  // 23 - 'Angry R 2'
    {0x00, 0x7E, 0x81, 0xB2, 0xA4, 0x88, 0x70, 0x00},  // 24 - 'Angry R 3'
    {0x00, 0x7F, 0x82, 0xB4, 0xA8, 0x90, 0x60, 0x00},  // 25 - 'Angry R 4'
    {0x00},                                            // 26
    {0x00, 0x3E, 0x41, 0x99, 0x99, 0x82, 0x7C, 0x00},  // 27 - 'Sad L 1'
    {0x00, 0x1E, 0x21, 0x59, 0x9A, 0x84, 0x78, 0x00},  // 28 - 'Sad L 2'
    {0x00, 0x0E, 0x11, 0x29, 0x5A, 0x84, 0x78, 0x00},  // 29 - 'Sad L 3'
    {0x00},                                            // 30
    {0x00},                                            // 31
    {0x00, 0x7C, 0x82, 0x99, 0x99, 0x41, 0x3E, 0x00},  // 32 - 'Sad R 1'
    {0x00, 0x78, 0x84, 0x9A, 0x59, 0x21, 0x1E, 0x00},  // 33 - 'Sad R 2'
    {0x00, 0x78, 0x84, 0x5A, 0x29, 0x11, 0x0E, 0x00},  // 34 - 'Sad R 3'
    {0x00},                                            // 35
    {0x00},                                            // 36
    {0x00, 0x7C, 0xC2, 0xB1, 0xB1, 0xC1, 0x7E, 0x00},  // 37 - 'Evil L 1'
    {0x00, 0x38, 0x44, 0xB2, 0xB1, 0x42, 0x3C, 0x00},  // 38 - 'Evil L 2'
    {0x00, 0x7E, 0xC1, 0xB1, 0xB1, 0xC2, 0x7C, 0x00},  // 39 -
};
static inline void cs_select() {
    asm volatile("nop \n nop \n nop");
    gpio_put(PICO_DEFAULT_SPI_CSN_PIN, 0);
    asm volatile("nop \n nop \n nop");
}

static inline void cs_deselect() {
    asm volatile("nop \n nop \n nop");
    gpio_put(PICO_DEFAULT_SPI_CSN_PIN, 1);
    asm volatile("nop \n nop \n nop");
}

static void write_register(uint8_t reg, uint8_t data, uint8_t module) {
    uint8_t buf[2];
    buf[0] = reg;
    buf[1] = data;
    cs_select();
    for (int i = 0; i < NUM_MODULES; i++) {
        if (i == module) {
            spi_write_blocking(spi_default, buf, 2);
        } else {
            spi_read_blocking(spi_default, 0, 0, 2);
        }
    }
    cs_deselect();
    sleep_ms(1);
}
static void write_register_all(uint8_t reg, uint8_t data) {
    uint8_t buf[2];
    buf[0] = reg;
    buf[1] = data;
    cs_select();
    for (int i = 0; i < NUM_MODULES; i++) {
        spi_write_blocking(spi_default, buf, 2);
    }
    cs_deselect();

}
void clear_display() {
    for (int i = 0; i < FONT_HEIGHT; i++) {
        for (int j = 0; j < NUM_MODULES; j++) {
            write_register(1 + i, 0, j);
        }
    }
}

void refresh_display() {
    for (int module = 0; module < NUM_MODULES; module++) {
        for (int i = 0; i < FONT_HEIGHT; i++) {
            write_register(1 + i, 0, module);
        }
    }
}

void display_character(char c, int offset, int module) {
    if (c >= ' ' && c <= '~') {
        int char_index = c - ' ';
        for (int i = 0; i < FONT_HEIGHT; i++) {
            if (char_index >= 0 && char_index < 95) {
                uint8_t row_data = FONT_8x8[char_index][i];
                write_register(1 + i, row_data >> offset, module);
            } else {
                write_register(1 + i, 0, module);
            }
        }
    } else {
        for (int i = 0; i < FONT_HEIGHT; i++) {
            write_register(1 + i, 0, module);
        }
    }
}

void display_text(const char* text) {
    int text_len = strlen(text);
    int num_modules = FONT_WIDTH * NUM_MODULES;
    int module_height = FONT_HEIGHT;

    clear_display();

    int max_chars = num_modules;
    int display_len = (text_len < max_chars) ? text_len : max_chars;

    for (int i = 0; i < display_len; i++) {
        display_character(text[i], i, i);
    }
}

void display_pattern(const uint8_t* pattern, int pattern_size, int start_module) {
    int module_height = FONT_HEIGHT;

    for (int module = start_module; module < start_module + (pattern_size / FONT_HEIGHT); module++) {
        for (int i = 0; i < module_height; i++) {
            write_register(1 + i, pattern[i + (module - start_module) * FONT_HEIGHT], module);
        }
    }

    //refresh_display();
}

void display_robot_pupils(const uint8_t left_pupil[], const uint8_t right_pupil[], int left_pupil_size, int right_pupil_size) {
    display_pattern(left_pupil, left_pupil_size, 1);
    display_pattern(right_pupil, right_pupil_size, 2);
    //refresh_display();
}
void spi0_init(){
    spi_init(spi_default, 10 * 1000 * 1000);
    gpio_set_function(PICO_DEFAULT_SPI_SCK_PIN, GPIO_FUNC_SPI);
    gpio_set_function(PICO_DEFAULT_SPI_TX_PIN, GPIO_FUNC_SPI);


    gpio_init(PICO_DEFAULT_SPI_CSN_PIN);
    gpio_set_dir(PICO_DEFAULT_SPI_CSN_PIN, GPIO_OUT);
    gpio_put(PICO_DEFAULT_SPI_CSN_PIN, 1);

    write_register_all(CMD_SHUTDOWN, 0);
    write_register_all(CMD_DISPLAYTEST, 0);
    write_register_all(CMD_SCANLIMIT, 7);
    write_register_all(CMD_DECODEMODE, 0);
    write_register_all(CMD_SHUTDOWN, 1);
    write_register_all(CMD_BRIGHTNESS, 8);
}
void display_robot_eyes(int frame_index) {
    if (frame_index >= 0 && frame_index < NUM_ROBOT_EYES_FRAMES) {
        display_pattern(ROBOT_EYES_FRAMES[frame_index], 8, 1);
        display_pattern(ROBOT_EYES_FRAMES[frame_index], 8, 2);
    } else {
        clear_display();
    }
}
void blink_eyes(uint16_t startNumber,uint16_t endNumber){
            for (int i = startNumber; i < endNumber; i++) {
            display_robot_eyes(i);
            sleep_ms(200);
            } 
            for (int i = endNumber; i > startNumber; i--) {
            display_robot_eyes(i);
            sleep_ms(200);
            }  
            sleep_ms(8000);
}